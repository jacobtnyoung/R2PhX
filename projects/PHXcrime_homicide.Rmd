---
title: "What is going on with violent crime in Phoenix?"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    theme: yeti
    toc: false
    toc_float: false
    collapsed: false
    smooth_scroll: false
---

```{r setup, include=FALSE}

knitr::opts_chunk$set( echo = TRUE, 
                      message = FALSE, 
                      warning = FALSE, 
                      fig.width = 12, 
                      fig.height = 10 )

rm( list = ls() )

```


```{r, echo = FALSE, eval = TRUE}

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #
# I run this chunk so that I can go through it and have the tabs show the code.

rm( list = ls() )

library( dplyr )
library( tidyr )
library( ggplot2 )
library( forecast )
library( scales )

# Get the data.
url <- "https://www.phoenixopendata.com/dataset/cc08aace-9ca9-467f-b6c1-f0879ab1a358/resource/0ce3411a-2fc6-4302-a33f-167f68608a20/download/crimestat.csv"
crime.data <- read.csv( url, as.is = TRUE, header = TRUE )
crime.data <- na.omit( crime.data )

# Help with formating the text.
n.cases <- dim( crime.data )[1]

# Clean up the dates.
date.vec <- strptime( crime.data$OCCURRED.ON, format="%m/%d/%Y %H:%M" )
crime.data$year   <- format( date.vec, format="%Y" )
crime.data$month  <- format( date.vec, format="%B" )
crime.data$day365 <- format( date.vec, format="%j" )

# Clean up the variable classifying the cases.
crime.data <- 
  crime.data %>% 
  mutate( crime.type = case_when( 
    UCR.CRIME.CATEGORY == "AGGRAVATED ASSAULT" ~ "Assault",
    UCR.CRIME.CATEGORY == "ARSON" ~ "Arson",
    UCR.CRIME.CATEGORY == "BURGLARY" ~ "Burglary",
    UCR.CRIME.CATEGORY == "DRUG OFFENSE" ~ "Drugs",
    UCR.CRIME.CATEGORY == "LARCENY-THEFT" ~ "Theft",
    UCR.CRIME.CATEGORY == "MURDER AND NON-NEGLIGENT MANSLAUGHTER" ~ "Homicide",
    UCR.CRIME.CATEGORY == "MOTOR VEHICLE THEFT" ~ "MV Theft",
    UCR.CRIME.CATEGORY == "RAPE" ~ "Rape",
    UCR.CRIME.CATEGORY == "ROBBERY" ~ "Robbery" ) )

# Drop cases for the most recent month.
crime.data <- crime.data[ ! ( 
  crime.data$month == format( Sys.Date(), format="%B" ) &
  crime.data$year == format( Sys.Date(), format="%Y" ) 
  ) , ]

# Select just the homicides.
homicide.data <-
  crime.data %>% 
  filter( crime.type == "Homicide"  )

# Create the object of homicides by day.
homicides.by.day <- 
  homicide.data %>% 
  select( year, month, day365 ) %>%   
  filter( !is.na( day365 ) ) %>% 
  group_by( year, month, day365 ) %>% 
  summarize( counts = n() ) %>% 
  ungroup() %>% 
  mutate( day.time = seq( 1, length( counts ) ) ) %>% 
  select( counts, day.time ) %>% 
  mutate( days = 
            seq( 
              as.Date( head( strptime( homicide.data$OCCURRED.ON, format="%m/%d/%Y %H:%M" ) ) )[1], 
              as.Date( tail( strptime( homicide.data$OCCURRED.ON, format="%m/%d/%Y %H:%M" ) ) )[6], 
              length.out = length( counts ) ) ) %>% 
  arrange( day.time )

homicides.by.day <- as.data.frame( homicides.by.day )

# Homicides by month.
homicides.by.month <-
  homicide.data %>% 
  select( year, month ) %>%   
  filter( year != 2015 ) %>%
  filter( !is.na( year ) ) %>% 
  group_by( year, month ) %>% 
  summarize( counts = n() ) %>% 
  arrange( match( month, month.name ) ) 
homicides.by.month$month <-factor( homicides.by.month$month,levels = month.name )
homicides.by.month$month <-factor( month.abb[homicides.by.month$month],levels = month.abb )


!!!HERE: need to reconcile these!!!
  What is differnet about them???
  
# Homicides by month.
homicides.by.month2 <- 
  homicide.data %>% 
  select( year, month ) %>%   
  filter( year != 2015 ) %>%  
  filter( !is.na( year ) ) %>% 
  group_by( year, month ) %>% 
  summarize( counts = n() ) %>% 
  spread( year, counts ) %>% 
  arrange( match( month, month.name ) ) %>% 
  select( !month )

# Now, lets use the ts() function to create a time series object.
monthly.homicides.by.year <- ts(
  matrix( as.matrix( homicides.by.month2 ), ncol = 1 ), 
  start=c( 2016, 1 ), 
  end=c( as.numeric( tail( names( homicides.by.month2 ), n=1 ) ), 12 ), frequency=12
)


monthly.homicides.by.year %>% 
  ggseasonplot(
    year.labels=FALSE,
    main = "Plot of Monthly Count of Homicides by Years for Phoenix" ) + 
  scale_y_continuous(label = comma) +
  theme_gray()


!!!It would be cool to get some sort of bands of confidence around each of these or something.
Also, the colors are not very useful.


```

<br>

TEXT HERE when you have something to say


CLEAN UP HERE
CLEAN UP HERE
CLEAN UP HERE
CLEAN UP HERE



*Note: as with other posts, just click the tab to see the code*...

<br><br>

### Monthly Counts of **Homicide** over the Years {.tabset}

<br>

#### 

<br>

Let's pull the most recent data for **crime incidents** from the site.

The data are reported as UCR crime classifications and have geographic information (block address, zip) as well as the date and time of the incident. As of `r format(Sys.time(), '%B, %Y')`, there were `r comma(n.cases)` crime incidents with complete data from 11/2015 to within a week of the current date.  

We will select just **homicides**. In the data, these appear as `MURDER AND NON-NEGLIGENT MANSLAUGHTER`, but recoded as *homicide*.

Let's start by looking at the monthly count.
  
<br>

```{r, echo = FALSE, eval = TRUE}

homicides.by.day %>% 
  ggplot( aes( days, counts ) ) +
  geom_line( color = "grey80" ) +
  geom_point( alpha = 1/5, color = "black" ) +
  labs( x = "", y = "Counts of Homicides per Day" ) + 
  ggtitle( "Daily Homicide Counts in Phoenix, AZ" ) +
  geom_smooth( color = "darkblue", span = 0.2 ) +
  scale_y_continuous(label = comma) +
  theme_minimal() 

```

<br>




```{r, echo=FALSE, eval=TRUE}

p1 <- homicides.by.month %>% 
  ggplot( aes( month, counts, group = 1 ) ) +
  geom_point( ) +
  geom_line( ) +
  facet_grid( ~ year , scales="free" ) +
  theme( axis.text.x=element_blank() ) +
  xlab( "Month" )

p1

```

TEXT

<br>

#### Getting the data (**code**)

```{r, echo = TRUE, eval = FALSE}

# UPDATE CODE HERE WITH WHAT YOU DID

```

<br>

#### Plotting the data (**code**)

```{r, echo=TRUE, eval=FALSE}
p1 <- crimes.by.month %>% 
  ggplot( aes( month, counts, group = 1 ) ) +
  geom_point( ) +
  geom_line( ) +
  facet_grid( ~ year , scales="free" ) +
  theme( axis.text.x=element_blank() ) +
  xlab( "Month" )
p1

p2 <- crimes.type.by.month %>% 
  ggplot( aes( month, counts, group = 1 ) ) +
  geom_point( ) +
  geom_line( ) +
  facet_grid( crime.type ~ year, scales="free" ) +
  theme( axis.text.x=element_blank(), 
         strip.text.x = element_text( size = 15 ),
         strip.text.y = element_text( size = 12 ) ) +
  xlab( "Month" )
p2
```

<br>



###

<br>

<p align="center">
[Back to R 2 Phoenix page](https://jacobtnyoung.github.io/R2PhX/)
</p>

<br>

###### ***Last updated `r format(Sys.time(), '%d %B, %Y')`***