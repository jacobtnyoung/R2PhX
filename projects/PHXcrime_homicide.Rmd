---
title: "What is going on with violent crime in Phoenix?"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    theme: yeti
    toc: false
    toc_float: false
    collapsed: false
    smooth_scroll: false
---

```{r setup, include=FALSE}

knitr::opts_chunk$set( echo = TRUE, 
                      message = FALSE, 
                      warning = FALSE, 
                      fig.width = 12, 
                      fig.height = 10 )

```


```{r, echo = FALSE, eval = TRUE}

# clear workspace.
rm( list = ls() )

# load libraries.
library( dplyr )
library( tidyr )
library( ggplot2 )
library( scales )
library( forecast )
library( openxlsx )


# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #
# Crime incidents.

# Get the data.
url <- "https://www.phoenixopendata.com/dataset/cc08aace-9ca9-467f-b6c1-f0879ab1a358/resource/0ce3411a-2fc6-4302-a33f-167f68608a20/download/crimestat.csv"
crime.data <- read.csv( url, as.is = TRUE, header = TRUE )
crime.data <- na.omit( crime.data )

# Help with formating the text.
n.cases <- dim( crime.data )[1]

# Clean up the dates.
date.vec <- strptime( crime.data$OCCURRED.ON, format="%m/%d/%Y %H:%M" )
crime.data$year   <- format( date.vec, format="%Y" )
crime.data$month  <- format( date.vec, format="%B" )
crime.data$day365 <- format( date.vec, format="%j" )

# Clean up the variable classifying the cases.
crime.data <- 
  crime.data %>% 
  mutate( crime.type = case_when( 
    UCR.CRIME.CATEGORY == "AGGRAVATED ASSAULT" ~ "Assault",
    UCR.CRIME.CATEGORY == "ARSON" ~ "Arson",
    UCR.CRIME.CATEGORY == "BURGLARY" ~ "Burglary",
    UCR.CRIME.CATEGORY == "DRUG OFFENSE" ~ "Drugs",
    UCR.CRIME.CATEGORY == "LARCENY-THEFT" ~ "Theft",
    UCR.CRIME.CATEGORY == "MURDER AND NON-NEGLIGENT MANSLAUGHTER" ~ "Homicide",
    UCR.CRIME.CATEGORY == "MOTOR VEHICLE THEFT" ~ "MV Theft",
    UCR.CRIME.CATEGORY == "RAPE" ~ "Rape",
    UCR.CRIME.CATEGORY == "ROBBERY" ~ "Robbery" ) )

# Drop cases for the most recent month.
crime.data <- crime.data[ ! ( 
  crime.data$month == format( Sys.Date(), format="%B" ) &
  crime.data$year == format( Sys.Date(), format="%Y" ) 
  ) , ]

# Select just the homicides.
homicide.data <-
  crime.data %>% 
  filter( crime.type == "Homicide"  )

# Create the object of homicides by day.
homicides.by.day <- 
  homicide.data %>% 
  select( year, month, day365 ) %>%   
  filter( !is.na( day365 ) ) %>% 
  group_by( year, month, day365 ) %>% 
  summarize( counts = n() ) %>% 
  ungroup() %>% 
  mutate( day.time = seq( 1, length( counts ) ) ) %>% 
  select( counts, day.time ) %>% 
  mutate( days = 
            seq( 
              as.Date( head( strptime( homicide.data$OCCURRED.ON, format="%m/%d/%Y %H:%M" ) ) )[1], 
              as.Date( tail( strptime( homicide.data$OCCURRED.ON, format="%m/%d/%Y %H:%M" ) ) )[6], 
              length.out = length( counts ) ) ) %>% 
  arrange( day.time )

homicides.by.day <- as.data.frame( homicides.by.day )

# Homicides by month.
homicides.by.month <- 
  homicide.data %>% 
  select( year, month ) %>%   
  filter( year != 2015 ) %>%  
  filter( !is.na( year ) ) %>% 
  group_by( year, month ) %>% 
  summarize( counts = n() ) %>% 
  spread( year, counts ) %>% 
  arrange( match( month, month.name ) ) %>% 
  select( !month )


# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #
# Population data for Phoenix.

# get the population data to create the rates.
pop.data <- read.xlsx(
  "https://www2.census.gov/programs-surveys/popest/tables/2010-2019/cities/totals/SUB-IP-EST2019-ANNRES-04.xlsx",
  colNames = TRUE,
  startRow = 4
)

# Find the row with the data for Phoenix.
grep("Phoenix", pop.data[,1])

# It is the 55th row in the object. So, we need to pull that row.
phoenix.pop <-  pop.data[55,]
phoenix.pop

# Now, we only need the data for 2016-2019.
phoenix.pop <- phoenix.pop[-c(1:9)]
phoenix.pop

# Just add the difference for each year until you get the actual demographic data..
phoenix.pop.2020 <- phoenix.pop[4] + phoenix.pop[4] - phoenix.pop[3]
phoenix.pop.2021 <- phoenix.pop.2020 + phoenix.pop[4] - phoenix.pop[3]
phoenix.pop.2022 <- phoenix.pop.2021 + phoenix.pop[4] - phoenix.pop[3]
phoenix.pop.data <- as.numeric( c( phoenix.pop, phoenix.pop.2020, phoenix.pop.2021, phoenix.pop.2022 ) )


# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #
# Create the rates using the population data.

# now, calculate the homicide rate. Crime rate is calculated as the count of homicides divided by the population size, then multiplied by 100,000.

homicide.rates <- as.data.frame( homicides.by.month )

for ( i in 1: dim( homicide.rates )[2] ){
 homicide.rates[,i] <- ( homicide.rates[,i] / homicide.rates[i] ) * 100000
}

# Create the time series.
monthly.homicides.by.year <- ts(
  matrix( as.matrix( homicides.by.month ), ncol = 1 ), 
  start=c( 2016, 1 ), 
  end=c( as.numeric( tail( names( homicides.by.month ), n=1 ) ), 12 ), frequency=12
)


# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #
# Build the plots you will present.

homicides.by.day %>% 
  ggplot( aes( days, counts ) ) +
  geom_line( color = "grey80" ) +
  geom_point( alpha = 1/5, color = "black" ) +
  labs( x = "", y = "Counts of Homicide per Day" ) + 
  ggtitle( "Daily Homicides in Phoenix, AZ" ) +
  geom_smooth( color = "darkblue", span = 0.2 ) +
  scale_y_continuous(label = comma) +
  theme_minimal() 

monthly.homicides.by.year %>% 
  ggseasonplot(
    year.labels=FALSE,
    main = "Plot of Monthly Homicide Rate by Years for Phoenix",
    col = rainbow( dim( homicide.rates )[2] ) ) + 
  scale_y_continuous( label = comma ) +
  geom_line( size = 1.2 ) +
  theme_gray() 

```

<br>

TEXT HERE when you have something to say


CLEAN UP HERE
CLEAN UP HERE
CLEAN UP HERE
CLEAN UP HERE



*Note: as with other posts, just click the tab to see the code*...

<br><br>

### Monthly Counts of **Homicide** over the Years {.tabset}

<br>

#### 

<br>

Let's pull the most recent data for **crime incidents** from the site.

The data are reported as UCR crime classifications and have geographic information (block address, zip) as well as the date and time of the incident. As of `r format(Sys.time(), '%B, %Y')`, there were `r comma(n.cases)` crime incidents with complete data from 11/2015 to within a week of the current date.  

We will select just **homicides**. In the data, these appear as `MURDER AND NON-NEGLIGENT MANSLAUGHTER`, but recoded as *homicide*.

Let's start by looking at the monthly count.
  
<br>

```{r, echo = FALSE, eval = TRUE}

homicides.by.day %>% 
  ggplot( aes( days, counts ) ) +
  geom_line( color = "grey80" ) +
  geom_point( alpha = 1/5, color = "black" ) +
  labs( x = "", y = "Counts of Homicide per Day" ) + 
  ggtitle( "Daily Homicides in Phoenix, AZ" ) +
  geom_smooth( color = "darkblue", span = 0.2 ) +
  scale_y_continuous(label = comma) +
  theme_minimal()  

```

<br>

TEXT

<br>

#### Getting the data (**code**)

```{r, echo = TRUE, eval = FALSE}

# UPDATE CODE HERE WITH WHAT YOU DID

```

<br>

#### Plotting the data (**code**)

```{r, echo=TRUE, eval=FALSE}
p1 <- crimes.by.month %>% 
  ggplot( aes( month, counts, group = 1 ) ) +
  geom_point( ) +
  geom_line( ) +
  facet_grid( ~ year , scales="free" ) +
  theme( axis.text.x=element_blank() ) +
  xlab( "Month" )
p1

p2 <- crimes.type.by.month %>% 
  ggplot( aes( month, counts, group = 1 ) ) +
  geom_point( ) +
  geom_line( ) +
  facet_grid( crime.type ~ year, scales="free" ) +
  theme( axis.text.x=element_blank(), 
         strip.text.x = element_text( size = 15 ),
         strip.text.y = element_text( size = 12 ) ) +
  xlab( "Month" )
p2
```

<br>



###

<br>

<p align="center">
[Back to R 2 Phoenix page](https://jacobtnyoung.github.io/R2PhX/)
</p>

<br>

###### ***Last updated `r format(Sys.time(), '%d %B, %Y')`***