---
title: "What's going on with crime in Phoenix?"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    theme: yeti
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE, 
                      message = FALSE, 
                      warning = FALSE, 
                      fig.width = 12, 
                      fig.height = 10)

rm(list = ls())

```

<br>

What do you think? Is crime on the rise? Is crime declining? Having a hard time answering that question (**and** *being confident about your answer*)? Well, you should? I certainly do (and I am a criminologist).  

<br>

And so are most people. [Gallup polling](https://news.gallup.com/poll/268283/describe-problem-crime-serious.aspx) has consistently shown that individuals' perceptions of crime does not (REPEAT **does not**) track trends in crime.  

Crime trends are **very** difficult to assess, without seeing the data, because of the peculiar nature of crime. 

  * First, crime is very concentrated in specific geographic areas and exposure to crime and victimization is disproportionately concentrated among groups. If you are fortunate enough to not experience victimization, then your assessment of the frequency of events probably comes from hearsay or media accounts. These are both "*biased*" accounts in the sense that they do not reflect representative cases of crime. In other words, we tend to hear about things that happen and don't really hear about when things don't happen.  

  * Second, when individuals do experience victimization, they tend to overestimate the prevalence of crime. This makes intuitive sense, but makes it difficult to assess the actual prevalence of crime.  

  * Third, we measure crime very poorly. There is often a large time gap between when crime happens and when those data are compiled into annual reports of crime. 

<br>

**But**, if you want to know about crime in Phoenix, there is the open data portal! Specifically, there are three files that pertain to the ["police" topic](https://www.phoenixopendata.com/organization/police-department):  

 *  [Officer Involved Shooting Incidents](https://www.phoenixopendata.com/dataset/officer-involved-shooting-incidents)  
 
 *  [Calls for Service](https://www.phoenixopendata.com/dataset/calls-for-service)  
 
 * And [Crime Incidents](https://www.phoenixopendata.com/dataset/crime-data)  

<br> 
 
For both the [Calls for Service](https://www.phoenixopendata.com/dataset/calls-for-service) and the [Crime Incidents](https://www.phoenixopendata.com/dataset/crime-data) data, the city updates the files at 11am every day. The files contains data beginning November 2015 up to 7 days before the posting date.

<br><br>

### To the Data! {.tabset} 

<br>

```{r, echo = FALSE, eval = TRUE}
url <- "https://www.phoenixopendata.com/dataset/cc08aace-9ca9-467f-b6c1-f0879ab1a358/resource/0ce3411a-2fc6-4302-a33f-167f68608a20/download/crimestat.csv"
crime.data <- read.csv(url, as.is = TRUE, header = TRUE)
```

#### Getting and Pre-processing the Data  

Let's pull the most recent data for **crime incidents** from the site.

```{r, echo = FALSE, eval = TRUE}
n.cases <- dim(crime.data)[1]
```  

The data are reported as UCR crime classifications and have geographic information (block address, zip) as well as the date and time of the incident. As of `r format(Sys.time(), '%d %B, %Y')`, there were `r n.cases` crime incidents from 11/2015 to within a week of the current date.   

#### Getting the data (code)  
```{r, echo = TRUE, eval = FALSE}

# set the url where the data are located.
url <- "https://www.phoenixopendata.com/dataset/cc08aace-9ca9-467f-b6c1-f0879ab1a358/resource/0ce3411a-2fc6-4302-a33f-167f68608a20/download/crimestat.csv"

# pull in the csv file.
crime.data <- read.csv(url, as.is = TRUE, header = TRUE)

# take a look at the data.
head(crime.data)  

``` 

#### Preprocessing the data (code)  

Now that the data are in the workspace, let's clean up the date and the crime categories to make plotting them fairly easy. For this step, we will use the  `lubridate()` package.

```{r, echo = TRUE, eval = TRUE}

# Load the library.
# install.packages("lubridate") # if you have not installed the package.
library(lubridate)

# create an object that is the time and the category.
dates.crimes <- data.frame(
  date = as.Date(mdy_hm(crime.data$OCCURRED.ON)),
  crime = crime.data$UCR.CRIME.CATEGORY,
  days.since = unclass(as.Date(mdy_hm(crime.data$OCCURRED.ON))) 
  )

# Let's drop those cases missing dates.
dates.crimes <- dates.crimes[is.na(dates.crimes$date) == FALSE,]

# The number of cases you had to drop due to missing.
dim(crime.data)[1] - dim(dates.crimes)[1] 

```

<br><br>

### Plot it! {.tabset}  

<br>

#### Plotting the Data

<br>

What does the plot say?

<br>

```{r, echo = FALSE, eval = TRUE}

# Set up the values we want to plot.
y.1 <- as.vector(table(dates.crimes$days.since - dates.crimes$days.since[1]))
x.1 <- c(seq(min(dates.crimes$days.since - dates.crimes$days.since[1]),max(dates.crimes$days.since - dates.crimes$days.since[1]),length.out = length(y.1)))

# Set up points for the years.
march.1.2020 <- (unclass(as.Date("2020-03-01")) - dates.crimes$days.since[1])
march.1.2019 <- (unclass(as.Date("2019-03-01")) - dates.crimes$days.since[1])
march.1.2018 <- (unclass(as.Date("2018-03-01")) - dates.crimes$days.since[1])
march.1.2017 <- (unclass(as.Date("2017-03-01")) - dates.crimes$days.since[1])
march.1.2016 <- (unclass(as.Date("2016-03-01")) - dates.crimes$days.since[1])
marches      <- cbind(march.1.2020,march.1.2019,march.1.2018,march.1.2017,march.1.2016)

### Set plot basics and axes.
plot.new()
plot.window(xlim = c(0, max(x.1)), ylim = c(min(y.1), max(y.1)+10))   

### Plot the values.  
points(x = x.1, y = y.1, col = "black", pch = 16, cex = 0.75)
lines(x = x.1, y = y.1, col = "grey75", pch = 16, cex = 0.75)

# Add a line and some text for March in the prior years.
for(i in 1:length(marches)){
  segments(marches[i], min(y.1), marches[i], 270,lwd = 1, lty = 2, col = "black")
}
text(marches[1], 275,"March 1, 2020", col="black", pos=1, cex=0.8)
text(marches[2], 275,"March 1, 2019", col="black", pos=1, cex=0.8)
text(marches[3], 275,"March 1, 2018", col="black", pos=1, cex=0.8)
text(marches[4], 275,"March 1, 2017", col="black", pos=1, cex=0.8)
text(marches[5], 275,"March 1, 2016", col="black", pos=1, cex=0.8)

# Add a lowess line to see the trend.
lines(lowess(x.1, y.1), type = "l", col= "black", lwd = 2)

# Add a title.
title("Reports of Crime for Phoenix\n[lowess shown in horizontal black line]")

```

#### Code for plot  

Now, we want to plot the data where the months are the x-axis and the frequency of the crimes are the y-axis. We have to set up some plot parameters first to get things looking nice.

```{r, echo = TRUE, eval = TRUE}

# Set up the values we want to plot.
y.1 <- as.vector(table(dates.crimes$days.since - dates.crimes$days.since[1]))
x.1 <- c(seq(min(dates.crimes$days.since - dates.crimes$days.since[1]),max(dates.crimes$days.since - dates.crimes$days.since[1]),length.out = length(y.1)))

# Set up points for the years.
march.1.2020 <- (unclass(as.Date("2020-03-01")) - dates.crimes$days.since[1])
march.1.2019 <- (unclass(as.Date("2019-03-01")) - dates.crimes$days.since[1])
march.1.2018 <- (unclass(as.Date("2018-03-01")) - dates.crimes$days.since[1])
march.1.2017 <- (unclass(as.Date("2017-03-01")) - dates.crimes$days.since[1])
march.1.2016 <- (unclass(as.Date("2016-03-01")) - dates.crimes$days.since[1])
marches      <- cbind(march.1.2020,march.1.2019,march.1.2018,march.1.2017,march.1.2016)

### Set plot basics and axes.
plot.new()
plot.window(xlim = c(0, max(x.1)), ylim = c(min(y.1), max(y.1)+10))   

### Plot the values.  
points(x = x.1, y = y.1, col = "black", pch = 16, cex = 0.75)
lines(x = x.1, y = y.1, col = "grey75", pch = 16, cex = 0.75)

# Add a line and some text for March in the prior years.
for(i in 1:length(marches)){
  segments(marches[i], min(y.1), marches[i], 270,lwd = 1, lty = 2, col = "black")
}
text(marches[1], 275,"March 1, 2020", col="black", pos=1, cex=0.8)
text(marches[2], 275,"March 1, 2019", col="black", pos=1, cex=0.8)
text(marches[3], 275,"March 1, 2018", col="black", pos=1, cex=0.8)
text(marches[4], 275,"March 1, 2017", col="black", pos=1, cex=0.8)
text(marches[5], 275,"March 1, 2016", col="black", pos=1, cex=0.8)

# Add a lowess line to see the trend.
lines(lowess(x.1, y.1), type = "l", col= "black", lwd = 2)

# Add a title.
title("Reports of Crime for Phoenix\n[lowess shown in horizontal black line]")

```

<br><br>
